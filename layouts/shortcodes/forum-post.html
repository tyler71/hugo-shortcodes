{{/* Usage: {{-< forum-post "555" >-}} */}}
{{/* Usage: {{-< forum-post id="555" domain="https://domain.tld" length="300" >-}} */}}

{{- $defaultDomain := "https://domain.tld" -}}


{{/* Take first argument, or if using named, postid */}}
{{- $postID := default (.Get 0) (.Get "id") -}}

{{/* Use scratch for dealing with scope */}}
{{- $scratch := newScratch -}}

{{- $urlPre := default $defaultDomain (.Get "domain") -}}
{{- $urlApi := "/api/posts/" -}}
{{- $postRequest := getJSON $urlPre $urlApi $postID -}}

{{/* Post Discussion Name */}}
{{- range $postRequest.included -}}
    {{- if eq .type "discussions" -}}
        {{- $scratch.Set "discussionName" .attributes.title -}}
    {{- end -}}
{{- end -}}
{{- $discussionName := $scratch.Get "discussionName" -}}

{{/* Discussion Number of Post */}}
{{- $discussionID := $postRequest.data.relationships.discussion.data.id -}}

{{/* Post Number of Discussion */}}
{{- $discussionPostID := $postRequest.data.attributes.number -}}

{{/* Post Author */}}
{{- range first 1 $postRequest.included -}}
    {{- if eq .type "users" -}}
        {{- $scratch.Set "authorID" .attributes.displayName -}}
        {{- $scratch.Set "usernameID" .attributes.username -}}
    {{- end -}}
{{- end -}}
{{- $forumPostAuthor := $scratch.Get "authorID" -}}
{{- $forumPostUsername := $scratch.Get "authorID" -}}

{{/* Post Content; truncate if length is set */}}
{{/* if >= 0, truncate to specified value. If less (-1) do not truncate */}}
{{- if and (.Get "length") (ge (.Get "length") 0) -}}
    {{- $scratch.Set "forumPostContent" (truncate (.Get "length") ($postRequest.data.attributes.contentHtml | safeHTML)) -}}
{{- else if and (.Get "length") (lt (.Get "length") 0) -}}
    {{- $scratch.Set "forumPostContent" ($postRequest.data.attributes.contentHtml | safeHTML) -}}
{{- else if .Site.Params.postLength -}}
    {{- $scratch.Set "forumPostContent" (truncate .Site.Params.postLength ($postRequest.data.attributes.contentHtml | safeHTML)) -}}
{{- else -}}
    {{- $scratch.Set "forumPostContent" ($postRequest.data.attributes.contentHtml | safeHTML) -}}
{{- end -}}
{{- $forumPostContent := $scratch.Get "forumPostContent" -}}

<div class="forum-post">
    <div class="forum-post-title">
        <a href={{- printf "%s/d/%s/%s" $urlPre (string $discussionID) (string $discussionPostID) -}}>{{- $discussionName -}}</a>
    </div>
    <div class="forum-post-author">
        <a href={{- printf "%s/u/%s" $urlPre (string $forumPostUsername) -}}>{{- $forumPostAuthor -}}</a>
    </div>
    <div class="forum-post-content">
        {{- $forumPostContent -}}
    </div>
</div>
